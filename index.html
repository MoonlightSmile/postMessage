<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>mmessage</title>
</head>

<body>
  <h1>留言板</h1>
  <form>
    <input type="text" name="name">
    <input type="text" name="content">
    <input type="submit" value="提交">
  </form>
  <ul class=message></ul>
  <script src="js/jquery-3.2.1.min.js"></script>
  <script src="//cdn1.lncld.net/static/js/3.4.2/av-min.js"></script>
  <script type="text/javascript">
  (function() {
    //*****V*****
    let view = document.querySelector("form");
    //*****C*****
    let control = {
      view: null,
      init: function(view) {
        this.view = view
        model.init()
        this.bindEvent()
      },
      bindEvent: function() {
        this.view.addEventListener("submit", (e) => {
          e.preventDefault()
          let name = this.view.querySelector("input[name=name]").value
          let content = this.view.querySelector("input[name=content]").value
          model.save(name, content)
        })
      },
      render: function() {
        this.view.querySelector("input[name=name]").value = "";
        this.view.querySelector("input[name=content]").value = "";
      },
      createNode: function(message) {
        let name = message.name
        let content = message.content
        let li = document.createElement("li")
        li.textContent = `${name}: ${content}`
        document.querySelector(".message").appendChild(li)
      }


    }
    //*****M*****
    let model = {
      init: function() {
        const appId = 'LFbYL9q21JFdefvmHFooVYlL-gzGzoHsz';
        const appKey = 'o7SI4VJ7WG1l1ngGOuIVozer';
        AV.init({ appId, appKey });
      },
      save: function(name, content) {
        let Message = AV.Object.extend('Message');
        let message = new Message();
        message.save({
          content: content,
          name: name
        }).then(function(object) {
          control.render()
          var query = new AV.Query('Message')
          query.find().then(function(message) {
            document.querySelector(".message").innerHTML = ""
            message.forEach(function(element, index) {
              let attr = element.attributes
              control.createNode(attr)
            });
          })
        })
      }
    }

    control.init(view)
  })()
  </script>
</body>

</html>